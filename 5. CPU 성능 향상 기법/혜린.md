# Ch.5 CPU 성능 향상 기법

## 5-1. 빠른 CPU를 위한 설계 기법

### 클럭

- 컴퓨터 부품들은 클럭 신호에 맞춰 일사불란하게 움직인다.
- CPU는 명령어 사이클이라는 정해진 흐름에 맞춰 명령어들을 실행한다.

빠른 CPU를 설계를 위해서는 클럭 속도를 높여야 한다.

- 그렇다면 클럭 속도를 무지막지하게 올리면 되나?
    
    → 너무 높여 버리면 발열 문제가 발생한다. 따라서 CPU 성능을 높이기 위해 클럭 속도만 높이는건 한계가 있다.
    

클럭 속도는 일정하지 않다. CPU는 필요할 때 클럭 속도를 순간적으로 높이고, 그렇지 않을 때는 유연하게 속도를 낮춘다. 

### 코어와 멀티 코어

- **CPU** 성능을 높이기 위해서는 **클럭 속도**뿐만 아니라 **CPU** 내부에 **코어와 쓰레드 수**를 늘리는 방법도 있다.
- 현대 기술의 발전으로 CPU는 **명령어를 실행하는 부품**이 아닌  **명령어를 실행하는 부품을 여러 개 포함하는 부품** 으로 사용되고 있다.기존에 알고 있던 CPU는 코어라는 용어로 사용되고 코어의 집합체를 현재 CPU로 사용되고 있는 것이다.
- 코어를 여러 개 포함하고 있는 **CPU**는 **멀티코어 프로세서**라 부른다.
- 코어가 많으면 많을수록 **CPU**의 성능은 증가하지만 **클럭 속도**와 마찬가지로 한계가 있다. **코어마다 처리한 연산이 적절하게 분배되지 않으면** 아무리 코어 수가 많더라도 연산 속도는 크게 차이 없다.

### 스레드와 멀티스레드

- 스레드: 실행 흐름의 단위이다. **CPU**에서 사용되는 **하드웨어적 스레드**가 있고, **프로그램**에서 사용되는 **소프트웨어적 스레드**가 있다.
    - 하드웨어적 스레드
        
        하나의 코어가 동시에 처리하는 명령어 단위를 의미한다. 예를 들어 **2코어 4스레드 CPU**는 명령어를 실행하는 부품을 두 개 포함하고, 한 번에 네 개의 명령어를 처리할 수 있는 **CPU**를 의미한다.
        
        이처럼 하나의 코어로 여러 명령어를 동시에 처리하는 **CPU**를 **멀티스레드 프로세서 또는 멀티스레드 CPU**라 한다.
        
    - 소프트웨어적 스레드
        
        **하나의 프로그램에서 독립적으로 실행되는 단위**를 의미한다.
        

### 멀티스레드 프로세서

- **하나의 코어로 여러 명령어를 동시에 처리하는 CPU이다.** 하나의 코어로 여러 명령어를 동시에 처리하려면 **레지스터**가 큰 역할을 한다.
- 하나의 명령어를 처리하기 위해 꼭 필요한 레지스터를 여러 개 갖고 있다면 하나의 코어로 여러 명령어를 동시에 처리할 수 있다.

## 5-2. 명령어 병렬 처리 기법

빠른 **CPU**를 만들려면 클럭 속도, 멀티코어, 멀티스레드를 지원하는 **CPU**를 만드는 것도 중요하지만 **CPU**가 쉬지 않고 시간을 알뜰하게 쓰며 작동하는 것도 중요하다. 

### 명령어 파이프라인

명령어 처리 과정을 클럭 단위로 나누어 보면 다음과 같다.

1. 명령어 인출(Instruction Fetch)
2. 명령어 해석(Instruction Decode)
3. 명령어 실행(Execute Instruction)
4. 결과 저장(Write Back)

중요한 점은 같은 단계가 겹치지만 않는다면 cpu는 각 단계를 동시에 실행할 수 있다.

명령어들을 명령어 파이프라인에 넣고, 동시에 처리하는 기법을 명령어 파이프라이닝 이라고 한다. 파이프라이닝이 높은 성능을 가져오기는 하지만, 성능 향상에 실패하는 경우도 있는데, 이를 파이프라인 위험 이라고 한다. 파이프라인 위험은 데이터 위험, 제어 위험, 구조적 위험이 있다.

- 데이터 위험

데이터 위험(Data Hazard) 명령어 간 '데이터 의존성'에 발생한다. 모든 명령어는 동시에 처리할 수 없다. 어떤 명령어는 이전 명령어를 끝까지 실행해야만 실행할 수 있는 경우도 있다. 데이터 의존적인 두 명령어를 무작정 동시에 실행하려고 하면 파이프라인이 제대로 작동하지 않는 것을 **데이터 위험**이라 한다.

- 제어 위험

제어 위험(Control Hazard)는 주로 분기 등으로 인한 '프로그램 카운터의 갑작스러운 변화'에 의해 발생한다. 갑자기 프로그램 실행 흐름이 바뀌어 명령어가 실행되면서 프로그램 카운터 값에 갑작스러운 변화가 생긴다면 **명령어 파이프라인**에 미리 가지고 와서 처리 중이었던 명령어들은 아무 쓸모가 없다. 이를 **제어 위험**이라 한다. 갑작스러운 변화를 예측하여 **파이프라인 위험**를 억제해주는 기술 중 하나를 **분기 예측(Branch Prediction)**이라 한다.

- 구조적 위험

구조적 위험(Structural Hazard)은 명령어들을 겹쳐 실행하는 과정에서 서로 다른 명령어가 동시에 **ALU**, 레지스터 등과 같은 **CPU** 부품을  사용하려고 할 때 발생한다.

### 슈퍼스칼라

- CPU 내부에 여러 개의 명령어 파이프라인을 포함한 구조를 슈퍼 스칼라라고 한다.
- 슈퍼스칼라 구조로 명령어 처리가 가능한 CPU를 슈퍼스칼라 프로세서, 슈퍼스칼라 CPU라고 한다.
- 일반적으로 **슈퍼스칼라 프로세서**는 파이프라인 갯수에 따라 프로그램 처리 속도가 빨라지지만 **파이프라인 위험** 등 예상치 못한 문제가 발생할 수 있어서 반드시 비례하는 것은 아니다.

### 비순차적 명령어 처리

**비순차적 명령어 처리(OoOE : Out of Order Execution)**는 명령어를 순차적으로 실행하지 않는 기법이다. 

**명령어 파이프라인이나 슈퍼스칼라** 같은 경우 명령어를 순차적으로 처리해 예상치 못한 문제들로 곧바로 명령어를 처리하지 못하는 경우가 있었다. 하지만 **비순차적 명령어 처리**는 처리 순서를 변경해도 서로 수행 결과에 미치지 못하는 경우 순차적으로 명령어를 처리하는 것이 아닌 효율적인 명령어 처리를 위해 **비순차적으로 명령어를 처리한다.** 

이를 통해 **명령어 파이프라인**은 멈추지 않을 것이고 좀 더 효율적인 명령어 실행을 할 수 있다.

## 5-3. CISC와 RISC

**CPU**가 파이프라이닝과 슈퍼스칼라 기법을 효과적으로 사용하려면 **CPU**가 인출하고 해석하고 실행하는 명령어가 파이프라이닝 하기 쉽게 생겨야 한다.

### 명령어 집합

- CPU가 이해할 수 있는 명령어들의 모음을 명령어 집합 또는 명령어 집합구조(ISA)라고 한다.
- ISA가 같은 CPU끼리는 서로의 명령어를 이해할 수 있지만 ISA가 다르면 서로의 명령어를 이해하지 못한다.
- ISA는 CPU의 언어이자 하드웨어가 소프트웨어를 어떻게 이해할지에 대한 연속이다.

### CISC

- Complex Instruction Set Computer의 약자
- 복잡한 명령어 집합을 활용하는 컴퓨터이다.
- 이름 그대로 복잡하고 다양한 명령어들을 활용하는 CPU 설계 방식이다.
- CISC는 다양하고 강력한 기능의 명령어 집합을 활용하기 때문에, 명령어의 형태나 크기가 다양한 가변 길이 명령어를 활용한다.
- 적은 수의 명령어만으로도 프로그램을 동작시킬 수 있다.
- 단점은 활용하는 명령어가 워낙 복잡하고, 다양한 기능을 제공하는 탓에 명령어의 크기와 실행되기까지의 시간이 일정하지 않다.
- 복잡한 명령어때문에 명령어 하나를 실행하는 데에 여러 클럭 주기를 필요로 한다.
- 명령어의 규격화가 어려워 파이프라이닝이 어렵다.

### RISC

- CISC의 한계
1. 빠른 처리를 위해 명령어 파이프라인을 십분 활용해야 한다. 원활한 파이프라이닝을 위해 명령어 길이와 수행 시간이 짧고, 규격화 되어야 한다.
2. 복잡한 기능을 지원하는 명령어를 추가하기보다는 자주 쓰이는 기본적인 명령어를 작고 빠르게 만드는 것이 중요하다.

- Reduced Instruction Set Computer의 약자
- CISC에 비해 명령어의 종류가 적다.
- CISC와는 달리 짧고 규격화된 명령어. 되도록 1클럭 내외로 실행되는 명령어를 지향한다.
- RISC는 고정 길이 명령어를 활용한다.
- 명령어 파이프라이닝에 최적화되어 있다.
- RISC는 메모리에 직접 접근하는 명령어를 load, store 두 개로 제한할 만큼 메모리 접근을 단순화하고 최소화를 추구한다. 주소 지정 방식의 종류가 적음.
- RISC를 load-store 구조라고 부르기도 한다.
- 메모리 접근을 최소화 하는 대신에, 레지스터를 적극적으로 활용한다. CISC보다 레지스터를 이용하는 연산이 많고, 범용 레지스터 개수도 더 많다.
