# Ch. 14 가상 메모리

## 14-1. 연속 메모리 할당

프로세스에 연속적인 메모리 공간을 할당하는 것을 말한다.

### 스와핑

현재 사용되지 않는 프로세스들을 보조기억장치의 일부 영역으로 쫓아내고 그렇게 생긴 빈 공간에 새 프로세스를 적재하는 방식

- 장점
    
    프로세스들이 요규하는 메모리 공간 크기 > 실제 메모리 크기인 경우에도 정상적으로 실행할 수 있다.
    

### 메모리 할당

프로세스는 메모리의 빈 공간에 할당되어야 한다.

- 최초 적합
    
    운영체제가 메모리 내의 빈 공간을 순서대로 검색하다 적재할 수 있는 공간을 발견하면 그 공간에 프로세스를 배치하는 방식이다.
    
    - 검색 최소화, 빠른 할당
- 최적 적합
    
    운영체제가 빈 공간을 모두 검색해본 뒤, 적재 가능한 가장 작은 공간에 할당하는 방식이다.
    
- 최악 적합
    
    운영체제가 빈 공간을 모두 검색해본 뒤, 적재 가능한 가장 큰 공간에 할당하는 방식이다.
    

사실 프로세스를 연속적으로 메모리에 할당하는 방식은 메모리를 효율적으로 사용하는 방법이 아니다. 이유는 **외부 단편화**라는 문제가 발생하기 때문이다.

### 외부 단편화

프로세스를 할당하기 어려울 만큼 작은 메모리 공간들로 인해 메모리가 낭비되는 현상을 말한다.

- 해결 방안
    - 메모리 압축
        
        여기저기 흩어져 있는 빈 공간들을 하나로 모으는 방식이다. 프로세스를 적당히 재배치시켜 흩어져 있는 작은 빈 공간들을 하나의 큰 빈 공간으로 만드는 방법이다.
        
        많은 오버헤드가 야기되고 시스템을 중지해야하는 등 많은 단점이 있다.
        

## 14-2 페이징을 통한 가상 메모리 관리

연속 메모리 할당은 두 가지 문제점이 있다. 앞서 말한 외부 단편화와 **물리 메모리보다 큰 프로세스를 실행할 수 없다는 것**이다.

- 가상 메모리
    - 실행하고자 하는 프로그램을 일부만 메모리에 적재하여 실제 물리 메모리 크기보다 더 큰 프로세스를 실행할 수 있게 하는 기술이다.
    - **페이징**, 세그멘테이션 기법이 존재한다.

### 페이징이란?

프로세스를 일정 크기로 자르고 이를 메모리에 불연속적으로 할당함으로서 외부 단편화를 해결한다.

- 페이징에서의 스와핑
    
    페이징에서도 스와핑이 가능하기 때문에 프로세스를 실행하기 위해 모든 페이지가 적재될 필요가 없다. 달리 말해 물리 메모리보다 큰 프로세스도 실행될 수 있다는 것을 의미한다.
    

### 페이지 테이블

만약 약 프로세스가 메모리에 불연속적으로 배치되어 있다면 CPU 는 이를 순차적으로 실행할 수가 없다. 이를 해결하기 위해 **페이지 테이블**을 이용한다.

- 페이지 테이블
    - 현재 어떤 프로세스의 어떤 페이지가 어떤 프레임에 할당되어 있는지를 짝지어주는 일종의 이정표이다.
    - 프로세스마다 페이지 테이블이 존재한다.

### 내부 단편화

페이징은 외부 단편화 문제를 해결할 수 있지만 내부 단편화라는 문제를 야기할 수 있다.

### PTBR

프로세스마다 페이지 테이블이 있고 각 페이지 테이블은 CPU 내의 **프로세스 테이블 베이스 레지스터**가 가리킨다.

하지만 이렇게 페이지 테이블을 메모리에 두면 메모리에 있는 페이지 테이블을 보기 위해 한 번, 프레임에 접근하기 위해 한 번 총 두 번의 메모리 접근이 필요하기 때문에 메모리 접근시간이 두 배로 늘어난다. 따라서 **TLB**라는 페이지 테이블의 캐시 메모리를 둔다. 

### 페이징에서의 주소 변환

하나의 페이지 혹은 프레임은 여러 주소를 포괄하고 있다. 따라서 특정 주소에 접근하려면 두 가지 정보가 필요하다.

1. 어떤 페이이지 혹은 프레임에 접근하고 싶은지
2. 접근하려는 주소가 그 페이지 혹은 프레임으로부터 얼마나 떨어져 있는지

따라서 페이징 시스템에서는 모든 논리 주소가 페이지 번호와 변위로 이뤄져 있다.

### 페이지 테이블 엔트리

페이지 테이블의 각각의 행들을 페이지 테이블 엔트리라고 한다. 페이지 정보, 프레임 번호 이외에도 여러 중요한 정보들이 있는데 아래와 같다.

- 유효 비트
    
    현재 해당 페이지에 접근 가능한지 여부를 알려준다. 만약 CPU가 유효 비트가 0인 페이지에 접근하려고 하면 페이지 폴트라는 예외가 발생한다.
    
- 보호 비트
    
    페이지 보호 기능을 위해 존재하는 비트이다. 읽기만 가능한지 혹은 쓰기만 가능한지 아니면 둘 다 가능한 페이지인지 나타낼 수 있다.
    
- 참조 비트
    
    CPU가 이 페이지에 접근한 적이 있는지 여부를 나타낸다.
    
- 수정 비트
    
    해당 페이지에 데이터를 쓴 적이 있는지 없는지 수정 여부를 알려준다.
    

## 14-3 페이지 교체와 프레임 할당

### 요구 페이징

프로세스를 메모리에 적재할 때 모든 페이지를 적재하지 않고 필요한 페이지만을 메모리에 적재하는 기법이다.

요구 페이징 시스템이 안정적으로 작동하려면 두 가지를 해결해야 한다.

- 페이지 교체
    
    메모레이 적재된 많은 페이지 중 어떤 페이지를 내보낼지 결정해야 하는데 이 방법을 페이지 교체 알고리즘이라고 한다.
    
- 프레임 할당

### 페이지 교체 알고리즘

좋은 페이지 교체 알고리즘이란 페이지 폴트를 가장 적게 일으키는 알고리즘을 말한다.

이 알고리즘을 제대로 이해하려면 페이지 폴트 횟수를 알 수 있어야 하며, 페이지 폴트 횟수는 페이지 참조열을 통해 알 수 있다.

- 페이지 참조열: CPU가 참조하는 페이지들 중 연속된 페이지를 생략한 페이지열을 말한다.
    
     ex.  222355 → 235
    
- FIFO 페이지 교체 알고리즘: 메모리에 가장 먼저 올라온 페이지부터 내쫓는 방식이다.
- 최적 페이지 교체 알고리즘: CPU에 의해 참조되는 횟수를 고려하는 페이지 교체 알고리즘이다.
- LRU 페이지 교체 알고리즘: 가장 오랫동안 사용되지 않은 페이지를 교체하는 알고리즘이다.

### 스래싱과 프레임 할당

- 스레싱
    - 프로세스가 실제 실행되는 시간보다 페이징에 더 많은 시간을 소요하여 성능이 저해되는 문제를 말한다.
    - 스레싱이 일어나는 근본적인 원인은 각 프로세스가 필요로 하는 최소한의 프레임 수가 보장되지 않았기 때문이다. 따라서 최소한의 프레임 수를 파악하고 프로세스들에게 적절한 수만큼 프레임을 할당해 줄 수 있어야 한다.
- 프레임 할당 방식
    
    프레임 할당 방식은 여러 개가 존재한다.
    
    - 균등 할당 방식: 모든 프로레스에 균등하게 프레임을 제공하는 방식
    - 비례 할당: 프로셋의 크기가 크면 프레임을 많이 할당하고 프로세스 크기가 작으면 프레임을 적게 나눠주는 방식
    - 작업 집합 모델 기반
    - 페이지 폴트율 기반
